
.PHONY: sd_config sd_install sd_status sd_stop sd_clean sd_enable

sd_config:
	$(QUIET)sed -e "s:_PYTHONPATH_:$(INSTALL_LOCATION):g" -e "s:_TWISDPATH_:$(TWISD_PATH):g" -e "s:_CONFIGFILE_:$(CFG_FILENAME):g" -e "s:_USER_:$(USERID):g"  -e "s:_GROUP_:$(GROUPID):g"  < $(SITE_TEMPLATE_PATH)/rs.service.in > $(SITE_TEMPLATE_PATH)/$(SYSTEMD_FILENAME)

	
sd_install: sd_config
	$(QUIET)$(SUDO) install -b -m 644 $(SITE_TEMPLATE_PATH)/$(SYSTEMD_FILENAME) $(SYSTEMD_PATH)/
	$(QUIET)$(SUDO) systemctl daemon-reload
	
sd_status:
	$(QUIET) systemctl status -l $(SYSTEMD_FILENAME) | cat

sd_start:
	$(QUIET)$(SUDO) systemctl start $(SYSTEMD_FILENAME)

sd_stop:
	$(QUIET)$(SUDO) systemctl stop $(SYSTEMD_FILENAME)

sd_restart:
	$(QUIET)$(SUDO) systemctl restart $(SYSTEMD_FILENAME)

sd_clean:
	$(QUIET)$(SUDO) systemctl disable $(SYSTEMD_FILENAME)
	$(QUIET)$(SUDO) rm -f $(SYSTEMD_PATH)/$(SYSTEMD_FILENAME)

sd_enable:
	$(QUIET)$(SUDO) systemctl enable $(SYSTEMD_FILENAME)


.PHONY:  src_install install uninstall

src_install: src_preinst
	$(QUIET)$(SUDO) install --owner=$(USERID) --group=$(GROUPID) -d $(INSTALL_LOCATION)
	$(QUIET)$(SUDO) cp -r $(SRC1_PATH)/server/recceiver/ $(INSTALL_LOCATION)/
	$(QUIET)$(SUDO) cp -r $(SRC1_PATH)/server/twisted/ $(INSTALL_LOCATION)/
	$(QUIET)$(SUDO) cp -r $(SRC2_PATH)/channelfinder/ $(INSTALL_LOCATION)/
	$(QUIET)$(SUDO) install -b -m 644 --owner=$(USERID) --group=$(GROUPID) $(SITE_TEMPLATE_PATH)/recsync.conf $(INSTALL_LOCATION)/
	$(QUIET)$(SUDO) install -b -m 644 --owner=$(USERID) --group=$(GROUPID) $(SITE_TEMPLATE_PATH)/channelfinderapi.conf $(INSTALL_LOCATION)/
	$(QUIET)$(SUDO)	chown -R $(USERID):$(GROUPID) $(INSTALL_LOCATION)

src_preinst:
	$(SUDO) sh $(SRC1_PATH)/debian/recceiver.postinst "configure"

src_postrm:
	$(QUIET)$(SUDO) sh $(SRC1_PATH)/debian/recceiver.postrm "purge"
	
## Install Service related files 
install: src_install sd_install sd_enable
	$(QUIET)echo "----- Note that one should start it and check its status via "
	$(QUIET)echo "----- systemctl start  $(SYSTEMD_FILENAME)"
	$(QUIET)echo "----- systemctl status $(SYSTEMD_FILENAME)"


## Uninstall ChannelFinder
uninstall: src_postrm sd_stop sd_clean
	$(QUIET)$(SUDO) rm -rf $(INSTALL_LOCATION)


reinstall: install

restart: uninstall reinstall sd_start sd_status sd_start